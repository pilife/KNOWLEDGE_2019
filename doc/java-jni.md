# JNI初探

有时，有必要使用本机代码（C / C ++）来克服Java中的内存管理和性能限制。 Java通过Java本地接口（JNI）支持本地代码。

#### Summary:

1. Java Code: 代码中声明哪里用到，并且定义加载
2. Javac: 编译生成头文件，可以指定输出目录（所以这边也可以自己写这个头文件？）
3. Native Code:一般在2输出目录下，编写实现的c/c++文件
4. Gcc/G++: 编译实现的文件，输出.so/.dll文件
5. Java: 运行java程序，一般都会带上-Djava.library.path参数，指定刚刚生成的类库的位置

所以1-3步是编写时候完成，4-5步一般是编译时候完成?

#### Detail：

1. 在java代码中**声明**用到native interface的地方，并且**加载**对应类库

   ```java
   public class HelloJNI {
      static {
         System.loadLibrary("hello"); // Load native library at runtime
                                      // hello.dll (Windows) or libhello.so (Unixes)
      }
    
      // Declare a native method sayHello() that receives nothing and returns void
      private native void sayHello();
    
      // Test Driver
      public static void main(String[] args) {
         new HelloJNI().sayHello();  // invoke the native method
      }
   }
   ```

2. 编译java文件，生成C/C++头文件 HelloJNI.h

   ```
   > javac -h . HelloJNI.java //java 1.8^
   ```

   ```
   > javac HelloJNI.java
   > javah HelloJNI
   ```

   ```c
   /* DO NOT EDIT THIS FILE - it is machine generated */
   #include <jni.h>
   /* Header for class HelloJNI */
    
   #ifndef _Included_HelloJNI
   #define _Included_HelloJNI
   #ifdef __cplusplus
   extern "C" {
   #endif
   /*
    * Class:     HelloJNI
    * Method:    sayHello
    * Signature: ()V
    */
   JNIEXPORT void JNICALL Java_HelloJNI_sayHello(JNIEnv *, jobject);
    
   #ifdef __cplusplus
   }
   #endif
   #endif
   ```

3. 实现程序：以C语言为例，即编写HelloJNI.c文件

   ```c
   //The header "jni.h" is available under the "<JAVA_HOME>\include" and "<JAVA_HOME>\include\win32" (for Windows) or "<JAVA_HOME>\include\linux" (for Ubuntu) [Check Mac OS X] directories, where <JAVA_HOME> is your JDK installed directory
   #include <jni.h> 
   #include <stdio.h>
   #include "HelloJNI.h"
    
   // Implementation of native method sayHello() of HelloJNI class
   JNIEXPORT void JNICALL Java_HelloJNI_sayHello(JNIEnv *env, jobject thisObj) {
      printf("Hello World!\n");
      return;
   }
   ```

4. 编译程序：注意上一步注释里的jni.h头文件的获取路径的添加

   ```
   gcc -fPIC -I"$JAVA_HOME/include" -I"$JAVA_HOME/include/linux" -shared -o libhello.so HelloJNI.c
   ```

5. 运行程序：注意java.library.path参数的设置，即为第一步里loadLibrary的路径

   ```
   java -Djava.library.path=. HelloJNI
   ```



Reference: 

[JNI Tutorial From NTU](https://www3.ntu.edu.sg/home/ehchua/programming/java/JavaNativeInterface.html)