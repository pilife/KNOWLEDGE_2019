# 区块链学习笔记

### 定义：

1. 区块链是一个放在非安全环境中的分布式数据库（系统）。
2. 区块链采用密码学的方法来保证已有数据不可能被篡改。
3. 区块链采用共识算法来对于新增数据达成共识。

具有以上三个性质的系统，就是区块链。



### 比特币共识：

1. 提议的交易信息被广播到比特币网络的每个节点

2. 每个节点把自己收到的交易信息写入一个新区块，写入新区块的交易信息如果成功加入到区块链里，就被成功执行了

3. 每一轮开始的时候，整个比特币网络里面某个节点被系统随机选择，被选择的节点把它自己的新区块广播给大家

4. 每个收到新区块的节点会对新区块里记录的交易。如果所有的新区块里记录的交易进行验证，验证无误以后把这个新区块加到自己的本地账本里。

   「节点对区块的检验」检验的到底是什么？实际上就是：

   - 检验区块内的交易记录签名是否准确（是否被篡改）（加密哈希 + 非对称加密）
   - 检验区块内的交易记录输入值是否“有效”（是否使用过）
   - 检验区块内的交易记录输入值的数字之和是否大于等于输出值的数字
   - …

#### 共识的问题：

1. Q：如果大家都是好人，但是因为网络的问题，有些节点可能收到了一个新的区块却没有收到老的区块。这会导致这个新区块无法被加入进去。

   A：好人节点会努力的向它的兄弟姐妹们把自己的区块同步到最新的状态。比特币网络遵循一个简单的原则，整个系统里最长的那条区块链，就是所有好人节点需要同步到的，也是整个系统承认的有效区块链。其他不够长的就是无效的，里面记录的交易也是无效。

   ​

2. Q1：这个随机选取某个节点来生成并广播下一个区块的随机选取过程又是什么？

   Q2：被选到的节点凭什么愿意努力干活生成这个区块，而不是偷懒耍滑摸鱼。

   A1：Proof of Work。

   比特币区块链中节点会将收到的等待确认的交易请求打包在一起，添加上前一个区块头部的哈希值等信息，组成一个区块结构。然后，试图找到一个 nonce 串（随机串）放到区块里，使得其哈希结果满足一定条件（比如小于某个值）。这个计算 nonce 串的过程，即俗称的“挖矿”。nonce 串的查找需要花费一定的计算力。

   比特币的这种基于算力（寻找 nonce 串）的共识机制被称为工作量证明（Proof of Work，PoW）。这是因为要让哈希结果满足一定条件，并无已知的快速启发式算法，只能对 nonce 值进行逐个尝试的蛮力计算。尝试的次数越多（工作量越大），算出来的概率越大。

   通过调节对哈希结果的限制条件（比如以多少个0开头），比特币网络控制平均约 10 分钟产生一个合法区块。算出区块的节点将得到区块中所有交易的管理费和协议固定发放的奖励费（目前是 12.5 比特币，每四年减半）。

   A2：奖励机制。

   ​

3. Q：【分叉】假如同一时间，多个节点同时挖到矿了（即通过POF算出了区块），怎么确定用哪个区块？

   A：引入了一条新的规则——拥有最多区块的支链将是真正被认可有价值的，较短的支链将会被直接Kill掉。挖矿的过程存在巨大的工作量（如果没有任何难度，把区块扔在人群中，必然同一时间发现区块的节点数量将大大增加，也就会产生无数的支链，通过这个例子，你大概也就能够明白，比特币的区块链世界为什么需要设置工作难度了吧），并且在计算机的硅基世界里，不可能出现所谓 “同时” 的概念，哪怕纳秒的差别，那也总是会有先后顺序。所以理论上，“分叉”的这种僵局很快会在下一个区块被挖掘出来（以及校验区块）的时候被打破，实在不行下下个，或者下下下个……总之机制可以让整个分叉的区块链世界迅速稳定下来。

   ​

4. Q1：这个系统里有坏人。我们研究一下系统有坏人以后会发生什么。坏人作恶有几种可能性。先看第一种，坏人想偷别人的钱，伪造交易记录。

   Q2：第二种坏人实行Deny of Service（拒绝服务）攻击。在坏人被选中产生区块的时候，坏人故意拒绝为某些特定的人服务。比如拒绝让给其他人同步最长链。

   Q3：第三种坏人【双花】。

   A1：这件事情是没办法做到的，因为坏人没法伪造交易记录，只要对方的私钥没有被偷。

   A2：因为囚徒困境，如果每个人都拒绝服务，比如传播最长链，那么自己也会无法获得最长链，导致自己无法获得收益。所以都会去当个好人提供服务。

   A3：双花的时候两笔矛盾的交易是不会出现在同一区块中的。于是总有一个被舍弃（与主链上的交易矛盾，即交易的源头已经被使用（每个交易都被格式化为：输入【A有多少钱（有多少有效交易）】，输出：【A转给B多少钱）），即输入已经变为无效，如果有零钱则增加一个【A转给A多少钱的有效交易】。<u>即使，双花同时分叉了</u>，也只需要多等待几轮新区块的加入，发现之前的交易区块没有被舍弃，即可确定交易生效（或者被舍弃）。



5. Q：为什么不能我负责挖前一百条交易的区块，你负责后一百条这样子。这样的话吞吐量就大了呀。

   ​

6. Q：分叉的时候何时才能拿到奖励。两个同时算出区块的nouce值。即如何确定被挖的区块已经并入主链。

   A：目前，每 10 分钟左右生成一个不超过 1 MB 大小的区块（记录了这 10 分钟内发生的验证过的交易内容），串联到最长的链尾部，每个区块的成功提交者可以得到系统 12.5 个比特币的奖励（**<u>该奖励作为区块内的第一个交易，一定区块数后才能使用</u>**），以及用户附加到交易上的支付服务费用。即便没有任何用户交易，矿工也可以自行产生合法的区块并获得奖励。

   PS：每个区块的奖励最初是 50 个比特币，每隔 21 万个区块自动减半，即 4 年时间，最终比特币总量稳定在 2100 万个。因此，比特币是一种通缩的货币。



7. 51%算力为什么能够破坏区块链？





### 比特币的缺陷：

- 比特币的交易速度很慢，10分钟一个区块的产生，交易的确认需要时间
- 比特币需要大量的烧电，用Proof of Work的协议来达到随机选择节点的目的
- 在比特币这个分布式共识系统里，能够做的只有转账问题





### Reference:

[比特币和区块链(3)：比特币的共识机制](https://zhuanlan.zhihu.com/p/33519275)

[区块链是什么，如何简单易懂地介绍区块链？](https://www.zhihu.com/question/37290469/answer/293890531)